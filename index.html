<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อ (Fix รายชื่อไม่ขึ้น)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; }
        #overlay { position: absolute; top: 0; left: 0; z-index: 10; }
        .scanning-line { position: absolute; width: 100%; height: 2px; background: #2563eb; animation: scan 2s linear infinite; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body class="bg-slate-50">

<div class="max-w-4xl mx-auto p-6">
    <header class="bg-white p-6 rounded-3xl shadow-sm mb-6 flex justify-between items-center border-b-4 border-blue-500">
        <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <i data-lucide="scan-face" class="text-blue-600"></i> Smart Recognition
        </h1>
        <div class="flex gap-2">
            <button onclick="location.reload()" class="p-2 bg-slate-100 rounded-lg"><i data-lucide="refresh-cw"></i></button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-4">
            <div class="relative bg-black rounded-3xl overflow-hidden shadow-2xl aspect-video">
                <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                <canvas id="overlay"></canvas>
                <div id="scan-line" class="scanning-line hidden"></div>
            </div>
            <div class="flex gap-4">
                <button onclick="startScanning()" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200">เปิดกล้อง</button>
                <button onclick="saveAttendance()" class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold">บันทึกข้อมูลเข้า Sheet</button>
            </div>
        </div>

        <div class="space-y-4">
            <div class="bg-white p-5 rounded-3xl shadow-sm h-full border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i data-lucide="user-check" class="text-green-500"></i> รายชื่อที่สแกนติด
                </h3>
                <div id="detected-container" class="space-y-2 max-h-[400px] overflow-y-auto">
                    <p id="no-data" class="text-slate-400 text-sm text-center py-10">ยังไม่มีรายชื่อสแกนติด</p>
                </div>
                <div class="mt-4 pt-4 border-t text-xs text-slate-400">
                    พบแล้ว: <span id="count-detected" class="font-bold text-blue-600 text-lg">0</span> คน
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let gasUrl = localStorage.getItem('gasUrl');
    let students = [], detectedSet = new Set(), faceMatcher = null;
    let stream = null, recognitionInterval = null;

    window.onload = async () => {
        lucide.createIcons();
        if (!gasUrl) { 
            gasUrl = prompt("กรุณาวาง Web App URL:"); 
            if(gasUrl) localStorage.setItem('gasUrl', gasUrl); 
        }
        await loadModels();
        await fetchStudentsData();
    };

    async function loadModels() {
        const URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
        await Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri(URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(URL)
        ]);
        console.log("AI Ready");
    }

    async function fetchStudentsData() {
        try {
            const res = await fetch(gasUrl, { method: 'POST', body: JSON.stringify({ action: 'getStudents' }) });
            const result = await res.json();
            if (result.success) {
                students = result.data;
                console.log("Loaded Students:", students.length);
                if (students.length > 0) await prepareMatcher();
            }
        } catch (e) { alert("ดึงข้อมูลนักเรียนไม่ได้: " + e); }
    }

    async function prepareMatcher() {
        const labeledDescriptors = await Promise.all(students.map(async s => {
            if (!s.imagedatabase64) return null;
            const img = await faceapi.fetchImage(s.imagedatabase64);
            const fullFaceDescription = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
            if (!fullFaceDescription) return null;
            // ใช้ StudentID เป็น Label เพื่อให้ Match ข้อมูลง่าย
            return new faceapi.LabeledFaceDescriptors(s.studentid, [fullFaceDescription.descriptor]);
        }));
        
        const validDescriptors = labeledDescriptors.filter(ld => ld !== null);
        if (validDescriptors.length > 0) {
            faceMatcher = new faceapi.FaceMatcher(validDescriptors, 0.6);
        }
    }

    async function startScanning() {
        const video = document.getElementById('video');
        stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        document.getElementById('scan-line').classList.remove('hidden');

        video.onplay = () => {
            const canvas = document.getElementById('overlay');
            const dims = faceapi.matchDimensions(canvas, video, true);
            
            recognitionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, dims);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                resizedDetections.forEach(d => {
                    const match = faceMatcher?.findBestMatch(d.descriptor);
                    const label = match ? match.toString() : "กำลังวิเคราะห์...";
                    
                    // วาดกรอบบนหน้าจอ
                    new faceapi.draw.DrawBox(d.detection.box, { label }).draw(canvas);

                    // ตรวจเช็ครายชื่อ
                    if (match && match.label !== 'unknown') {
                        addDetectedStudent(match.label);
                    }
                });
            }, 500);
        };
    }

    function addDetectedStudent(studentId) {
        if (!detectedSet.has(studentId)) {
            detectedSet.add(studentId);
            const student = students.find(s => s.studentid === studentId);
            if (student) {
                const container = document.getElementById('detected-container');
                const noData = document.getElementById('no-data');
                if (noData) noData.remove();

                const div = document.createElement('div');
                div.className = "flex items-center gap-3 bg-green-50 p-3 rounded-2xl animate-bounce-short";
                div.innerHTML = `
                    <img src="${student.imagedatabase64}" class="w-10 h-10 rounded-full object-cover shadow-sm">
                    <div>
                        <p class="text-sm font-bold text-green-700">${student.name}</p>
                        <p class="text-[10px] text-green-600">${student.studentid} | ${student.class}</p>
                    </div>
                `;
                container.prepend(div);
                document.getElementById('count-detected').innerText = detectedSet.size;
            }
        }
    }

    async function saveAttendance() {
        if (detectedSet.size === 0) return alert("ยังไม่มีรายชื่อที่สแกนติด");
        
        const payload = students.map(s => ({
            id: s.studentid,
            name: s.name,
            class: s.class,
            timestamp: new Date().toISOString(),
            location: 'Main Gate',
            status: detectedSet.has(s.studentid) ? 'มาเรียน' : 'ขาด'
        }));

        const res = await fetch(gasUrl, { method: 'POST', body: JSON.stringify({ action: 'recordAttendanceBulk', data: payload }) });
        const result = await res.json();
        if (result.success) {
            alert("บันทึกข้อมูลเรียบร้อย!");
            location.reload();
        }
    }

    function stopScanning() {
        if (recognitionInterval) clearInterval(recognitionInterval);
        if (stream) stream.getTracks().forEach(t => t.stop());
    }
</script>
</body>
</html>